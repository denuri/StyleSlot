<div class="booking-container">
  <app-navbar></app-navbar>

  <main class="main-content">
    <div class="header">
      <h1>Book Your Appointment</h1>
      <p>Choose your service, staff, and preferred time slot</p>
    </div>

    <!-- Access Denied Message -->
    <div class="access-denied" *ngIf="errorMessage && errorMessage.includes('Please log in')">
      <div class="access-denied-content">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="#ef4444" stroke-width="2" />
          <line x1="15" y1="9" x2="9" y2="15" stroke="#ef4444" stroke-width="2" />
          <line x1="9" y1="9" x2="15" y2="15" stroke="#ef4444" stroke-width="2" />
        </svg>
        <h2>Login Required</h2>
        <p>{{ errorMessage }}</p>
        <button class="back-btn" routerLink="/login">Go to Login</button>
      </div>
    </div>

    <!-- Main Booking Form -->
    <div class="booking-form" *ngIf="!errorMessage || !errorMessage.includes('Please log in')">
      <!-- Progress Steps -->
      <div class="progress-steps">
        <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1" (click)="goToStep(1)">
          <div class="step-number">1</div>
          <div class="step-label">Choose Service</div>
        </div>
        <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2" (click)="goToStep(2)">
          <div class="step-number">2</div>
          <div class="step-label">Select Staff</div>
        </div>
        <div class="step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3" (click)="goToStep(3)">
          <div class="step-number">3</div>
          <div class="step-label">Pick Date</div>
        </div>
        <div class="step" [class.active]="currentStep >= 4" [class.completed]="currentStep > 4" (click)="goToStep(4)">
          <div class="step-number">4</div>
          <div class="step-label">Choose Time</div>
        </div>
      </div>

      <!-- Messages -->
      <div class="messages" *ngIf="errorMessage || successMessage">
        <div class="error-message" *ngIf="errorMessage">
          {{ errorMessage }}
          <button class="close-btn" (click)="clearMessages()">×</button>
        </div>
        <div class="success-message" *ngIf="successMessage">
          {{ successMessage }}
          <button class="close-btn" (click)="clearMessages()">×</button>
        </div>
      </div>

      <!-- Step 1: Choose Service -->
      <div class="step-content" *ngIf="currentStep === 1">
        <h2>Select a Service</h2>
        <p>Choose the service you'd like to book</p>

        <div class="services-grid">
          <div class="service-card" *ngFor="let service of services" [class.selected]="selectedService === service._id"
            (click)="selectedService = service._id; onServiceChange()">
            <div class="service-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="#4ade80" />
              </svg>
            </div>
            <div class="service-info">
              <h3>{{ service.name }}</h3>
              <p class="service-description">{{ service.description }}</p>
              <div class="service-details">
                <span class="duration">{{ service.duration }} min</span>
                <span class="price">${{ service.price }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Select Staff -->
      <div class="step-content" *ngIf="currentStep === 2">
        <h2>Choose Your Stylist</h2>
        <p>Select a staff member for your appointment</p>

        <div class="staff-grid">
          <div class="staff-card" *ngFor="let staffMember of staff" [class.selected]="selectedStaff === staffMember._id"
            (click)="selectedStaff = staffMember._id; onStaffChange()">
            <div class="staff-avatar">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="12" fill="#4ade80" />
                <path
                  d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z"
                  fill="white" />
                <path d="M20 21C20 16.5817 16.4183 13 12 13C7.58172 13 4 16.5817 4 21" fill="white" />
              </svg>
            </div>
            <div class="staff-info">
              <h3>{{ staffMember.name }}</h3>
              <p class="staff-role">{{ staffMember.role }}</p>
              <p class="staff-email">{{ staffMember.email }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Pick Date -->
      <div class="step-content" *ngIf="currentStep === 3">
        <h2>Select Date</h2>
        <p>Choose a date for your appointment</p>

        <div class="date-selection">
          <div class="selected-info">
            <div class="info-item">
              <span class="label">Service:</span>
              <span class="value">{{ getSelectedService()?.name }}</span>
            </div>
            <div class="info-item">
              <span class="label">Staff:</span>
              <span class="value">{{ getSelectedStaffMember()?.name }}</span>
            </div>
          </div>

          <div class="date-input">
            <label for="appointmentDate">Appointment Date</label>
            <input type="date" id="appointmentDate" [(ngModel)]="selectedDate" (change)="onDateChange()"
              [min]="getMinDate()">
          </div>
        </div>
      </div>

      <!-- Step 4: Choose Time -->
      <div class="step-content" *ngIf="currentStep === 4">
        <h2>Select Time Slot</h2>
        <p>Choose your preferred time</p>

        <div class="time-selection">
          <div class="selected-info">
            <div class="info-item">
              <span class="label">Service:</span>
              <span class="value">{{ getSelectedService()?.name }}</span>
            </div>
            <div class="info-item">
              <span class="label">Staff:</span>
              <span class="value">{{ getSelectedStaffMember()?.name }}</span>
            </div>
            <div class="info-item">
              <span class="label">Date:</span>
              <span class="value">{{ getFormattedDate(selectedDate) }}</span>
            </div>
          </div>

          <div class="loading" *ngIf="isLoading">
            <div class="spinner"></div>
            <p>Loading available time slots...</p>
          </div>

          <div class="time-slots" *ngIf="!isLoading && availableSlots.length > 0">
            <h3>Available Time Slots</h3>
            <div class="slots-grid">
              <button class="time-slot" *ngFor="let slot of availableSlots" [class.selected]="selectedTime === slot"
                (click)="onTimeSelect(slot)">
                {{ getFormattedTime(slot) }}
              </button>
            </div>
          </div>

          <div class="no-slots" *ngIf="!isLoading && availableSlots.length === 0">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" stroke="#9ca3af" stroke-width="2" />
              <polyline points="12,6 12,12 16,14" stroke="#9ca3af" stroke-width="2" />
            </svg>
            <h3>No Available Slots</h3>
            <p>No time slots available for this date. Please try another date.</p>
          </div>
        </div>

        <!-- Notes Section -->
        <div class="notes-section" *ngIf="selectedTime">
          <label for="notes">Additional Notes (Optional)</label>
          <textarea id="notes" [(ngModel)]="notes"
            placeholder="Any special requests or notes for your appointment..."></textarea>
        </div>

        <!-- Booking Summary -->
        <div class="booking-summary" *ngIf="selectedTime">
          <h3>Booking Summary</h3>
          <div class="summary-item">
            <span class="label">Service:</span>
            <span class="value">{{ getSelectedService()?.name }} - ${{ getSelectedService()?.price }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Staff:</span>
            <span class="value">{{ getSelectedStaffMember()?.name }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Date & Time:</span>
            <span class="value">{{ getFormattedDate(selectedDate) }} at {{ getFormattedTime(selectedTime) }}</span>
          </div>
          <div class="summary-item total">
            <span class="label">Total:</span>
            <span class="value">${{ getSelectedService()?.price }}</span>
          </div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="navigation-buttons">
        <button class="btn-secondary" *ngIf="currentStep > 1" (click)="previousStep()">
          Previous
        </button>
        <button class="btn-primary" *ngIf="currentStep < totalSteps" [disabled]="!canProceedToNextStep()"
          (click)="nextStep()">
          Next
        </button>
        <button class="btn-primary" *ngIf="currentStep === totalSteps" [disabled]="!selectedTime || isLoading"
          (click)="createBooking()">
          <span *ngIf="!isLoading">Book Appointment</span>
          <span *ngIf="isLoading">Booking...</span>
        </button>
      </div>
    </div>
  </main>

  <app-footer></app-footer>
</div>
